input {
  file {
      path => "/var/log/nginx/access.log"
      codec => json
      type => "nginx"
  }
  file {
      path => "/opt/tomcat/data/stats-*.log"
      start_position => "beginning"
      type => "stats"
  }
}
filter {
	if [type] == "nginx" {
	  grok {
	  	patterns_dir => "/etc/logstash/patterns"
	    match => { "message" => "%{NGINXACCESS}" }
	  }
	  date {
	    match => [ "time" , "dd/MMM/YYYY:HH:mm:ss Z" ]
	  }
	  geoip {
	    source => "remote_ip"
		target => "geoip"
		database => "/etc/logstash/GeoLite2-City.mmdb"
	    add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
	    add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]    
	  }  
	  mutate {
	  	convert => [ "[geoip][coordinates]", "float"]
	  }
	  useragent {
	    source => "agent"
	    target => "user_agent"
	  }  
 	}
	if [type] == "stats" {
		json{
		    source => "message"
		}
		geoip {
			source => "ip"
			target => "geoip"
			database => "/etc/logstash/GeoLite2-City.mmdb"
			add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
			add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]    
		}
		mutate {
			convert => [ "[geoip][coordinates]", "float"]
		}
		ruby {
		    code => "event['timestamp'] = Time.at(event['timestamp']).strftime('%Y-%m-%dT%H:%M:%S') + '.' + event['microsecs'].to_s[1,3] + 'Z'"
		}
	}
}
output {
	elasticsearch {
	    index => "%{type}"
	    hosts => ["localhost:9200"]
	    document_type => "%{type}"
  	}
}
